# 关卡4 - 机关地牢 设计文档

## 概述

关卡4是一个专门展示新增死亡细胞风格机关系统的关卡。玩家需要通过观察机关规律、利用跳板、躲避锯片、快速通过易碎平台，最终踩下压力开关打开出口门。

## 关卡布局

```
                                              ┌─────┐
                                              │出口门│
                                              └──┬──┘
     玩家起点                                    │
        ↓                                       ●传送门
     ┌──────┐                              ┌────────┐
     │平台1 │     ┌────┐    ┌────┐        │ 平台6  │
     └──────┘     │平台2│    │平台3│        └────────┘
                  └────┘    └────┘
  ★跳板1                        ★跳板2
                  ◇易碎1  ◇易碎2  ◇易碎3
                                              ┌────────┐
                             ┌────┐           │ 平台5  │
                             │平台4│           │ ★开关  │
                             └────┘           └────────┘
     
△静态   △静态   △周期   △周期
尖刺1   尖刺2   尖刺1   尖刺2
                  ⚙锯1                ⚙锯2(圆周)
════════════════════════════════════════════════════════
                        地面
```

## 机关详情

### 1. 跳板 (Springboards)
- **跳板1** (位置: -480, 92)
  - 弹跳力: 450
  - 作用: 帮助玩家跳上平台1
  
- **跳板2** (位置: 200, -124)
  - 弹跳力: 500
  - 作用: 帮助玩家跳上更高区域

### 2. 尖刺 (Spikes)
- **静态尖刺** (位置: -300, 84 和 -100, 84)
  - 类型: STATIC
  - 伤害: 1
  - 特点: 永久存在，需要跳跃躲避

- **周期尖刺** (位置: 100, 84 和 300, 84)
  - 类型: PERIODIC
  - 伸出时间: 2秒
  - 缩回时间: 2秒
  - 警告时间: 0.5秒
  - 特点: 交错触发（第二个延迟1秒），需要观察规律

### 3. 锯片 (Saw Blades)
- **直线移动锯片** (位置: -200, 50)
  - 类型: LINEAR
  - 旋转速度: 300°/s
  - 移动速度: 50
  - 移动距离: 60
  - 特点: 上下移动，需要观察规律通过

- **圆周运动锯片** (位置: 0, -30)
  - 类型: CIRCULAR
  - 旋转速度: 400°/s
  - 移动速度: 30
  - 圆周半径: 50
  - 特点: 围绕中心旋转，需要把握时机

### 4. 易碎平台 (Crumbling Platforms)
- **易碎平台1** (位置: -100, -50)
  - 崩塌延迟: 0.8秒
  - 重生时间: 4秒

- **易碎平台2** (位置: 100, -120)
  - 崩塌延迟: 0.6秒
  - 重生时间: 4秒

- **易碎平台3** (位置: 300, -120)
  - 崩塌延迟: 0.7秒
  - 重生时间: 4秒

### 5. 压力开关和门 (Switch & Door)
- **压力开关** (位置: 400, -64)
  - 链接门ID: "exit_door"
  - 触发: 玩家站上去后激活

- **出口门** (位置: 600, 50)
  - 类型: SWITCH (需要开关触发)
  - 门ID: "exit_door"

## 挑战流程

1. **起点区域**: 玩家从左侧开始，学习使用跳板
2. **尖刺区域**: 穿过静态和周期尖刺，学习观察规律
3. **锯片区域**: 躲避移动锯片和圆周锯片
4. **易碎平台区域**: 快速通过三个易碎平台
5. **开关区域**: 踩下开关打开出口门
6. **终点**: 通过门到达传送门

## 收集品

- **金币**: 10枚（9枚常规路线 + 1枚隐藏在左下角）
- **隐藏金币**: 在起点左侧墙边，需要逆向探索

## 敌人

- **史莱姆**: 1只，位于终点附近，增加最后的挑战

## 提示标签

关卡中设置了4个提示标签：
1. "跳板可弹跳" - 介绍跳板功能
2. "注意尖刺！" - 警告危险区域
3. "易碎平台" - 提示平台会崩塌
4. "观察节奏" - 提示周期机关的规律

## 难度评估

- **预估通关时间**: 2-3分钟
- **难度等级**: 困难
- **死亡风险点**:
  - 周期尖刺 (中等)
  - 移动锯片 (中等)
  - 易碎平台连跳 (高)
  - 圆周锯片 (中等)

## 技术说明

### 开关-门链接机制
```
PressureSwitch (linked_door_ids = ["exit_door"])
      ↓ 玩家站上
      ↓ _activate()
      ↓ _trigger_linked_doors()
      ↓ get_tree().get_nodes_in_group("door")
      ↓ 找到 door_id == "exit_door" 的门
      ↓ door.toggle_door()
      ↓ 门打开
```

### 易碎平台状态流程
```
STABLE → (玩家站上) → CRUMBLING → (延迟后) → FALLING → COLLAPSED → (重生) → STABLE
```

## 后续改进建议

1. 添加检查点系统，避免死亡从头开始
2. 添加更多视觉提示（粒子效果、颜色变化）
3. 考虑添加难度选择（简单模式下机关伤害更低）
4. 添加成就系统（无伤通关、收集全部金币等）
