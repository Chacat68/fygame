# 游戏机制文档

本文档详细描述了游戏中的所有核心机制和系统，为开发和设计提供参考。

## 目录

1. [玩家系统](#玩家系统)
2. [敌人系统](#敌人系统)
3. [关卡系统](#关卡系统)
4. [游戏状态管理](#游戏状态管理)
5. [资源管理系统](#资源管理系统)
6. [UI系统](#ui系统)
7. [物理与碰撞系统](#物理与碰撞系统)

## 玩家系统

### 基本属性

- **移动速度**：130.0
- **跳跃速度**：-300.0
- **最大跳跃次数**：2（双跳能力）
- **最大生命值**：100
- **受伤伤害值**：10
- **无敌时间**：1.0秒

### 状态机系统

玩家使用状态机模式管理不同状态下的行为。所有状态继承自基础`PlayerState`类，实现以下方法：

- `enter()`：进入状态时调用
- `exit()`：退出状态时调用
- `physics_process(delta)`：处理物理更新
- `handle_input()`：处理输入
- `update_animation()`：更新动画

#### 玩家状态

1. **Idle状态**：玩家静止不动时的状态
2. **Run状态**：玩家水平移动时的状态
3. **Jump状态**：玩家跳跃上升时的状态
4. **Fall状态**：玩家下落时的状态
5. **Hurt状态**：玩家受伤时的状态
6. **Death状态**：玩家死亡时的状态

### 玩家输入处理

- 左右方向键：水平移动
- 空格键/上方向键：跳跃
- 双击跳跃键：二段跳

### 玩家复活机制

当玩家死亡后，游戏状态会设置`player_respawning`标志，在玩家重新生成时应用复活效果。

## 敌人系统

### 史莱姆敌人

#### 基本属性

- **移动速度**：45
- **生命值**：由难度和类型决定
- **伤害值**：碰撞时对玩家造成伤害

#### 行为模式

1. **巡逻行为**：
   - 在平台上左右移动
   - 使用射线检测避免掉落平台边缘
   - 碰到墙壁时改变方向

2. **碰撞检测**：
   - 使用`RayCast`检测前方障碍物和平台边缘
   - 使用`FloorCheck`射线检测平台边缘

#### 史莱姆类型

- **绿色史莱姆**：基础敌人，移动速度较慢
- **紫色史莱姆**：高级敌人，移动速度较快，生命值更高

## 关卡系统

### 关卡结构

每个关卡分为四个主要区域：

1. **入口区域**：简单的平台和少量敌人，作为教学区域
2. **中间区域**：增加难度，更多的跳跃挑战和敌人
3. **挑战区域**：高难度区域，复杂的平台布局和更多敌人
4. **宝藏区域**：关卡终点，包含大量奖励

### 随机关卡生成

游戏支持程序化生成随机关卡，主要参数包括：

- **平台间距**：80-150像素
- **平台高度变化**：-30到30像素
- **移动平台概率**：根据区域不同从10%到50%
- **紫色史莱姆概率**：根据区域不同从0%到40%

### 生物群系系统

随机关卡支持不同的生物群系，每种群系有独特的特性：

1. **森林**：
   - 平台颜色：绿色
   - 敌人类型：绿色史莱姆、紫色史莱姆
   - 资源类型：金币、水果
   - 氧气水平：1.2（充足）

2. **洞穴**：
   - 平台颜色：灰色
   - 敌人类型：绿色史莱姆、紫色史莱姆
   - 资源类型：金币
   - 氧气水平：0.8（较少）

3. **沼泽**：
   - 平台颜色：棕色
   - 敌人类型：紫色史莱姆
   - 资源类型：金币
   - 氧气水平：0.6（稀少）

### 房间系统

关卡可以包含不同类型的房间：

- **入口房间**：关卡起点
- **走廊房间**：连接不同区域
- **储藏室**：包含资源和奖励
- **氧气房间**：提供氧气补充
- **挑战房间**：高难度区域
- **宝藏房间**：关卡终点

### 传送门系统

传送门用于在关卡之间传送玩家：

- 可以设置特定的目标关卡
- 包含视觉效果和粒子系统
- 通过碰撞检测触发传送

## 游戏状态管理

### 全局游戏状态

- **player_respawning**：玩家是否正在复活
- **current_level**：当前关卡编号
- **max_unlocked_level**：最大已解锁关卡
- **total_coins**：玩家收集的总金币数
- **completed_levels**：已完成的关卡记录

### 游戏进度保存

游戏进度保存在`user://game_progress.json`文件中，包含以下信息：

- 当前关卡
- 最大已解锁关卡
- 总金币数
- 已完成关卡记录

### 多关卡管理

`MultiLevelManager`负责管理多个随机关卡：

- 使用关卡种子确保每次生成相同的关卡
- 处理关卡之间的切换
- 根据关卡编号调整难度参数

## 资源管理系统

### 资源类型

`ResourceManager`集中管理游戏中的所有资源：

1. **音效资源**：
   - 跳跃音效
   - 受伤音效
   - 金币音效
   - 能量提升音效
   - 爆炸音效
   - 点击音效

2. **音乐资源**：
   - 冒险背景音乐

3. **精灵资源**：
   - 骑士精灵
   - 金币精灵
   - 绿色史莱姆精灵
   - 紫色史莱姆精灵
   - 平台精灵
   - 世界瓦片集
   - 水果精灵
   - 金币图标

4. **场景资源**：
   - 金币场景
   - 史莱姆场景
   - 平台场景
   - 浮动文本场景

### 单例模式

资源管理器使用单例模式，确保全局只有一个实例：

- 通过`get_instance()`获取单例实例
- 通过`get_sound()`, `get_sprite()`, `get_scene()`等方法获取资源

## UI系统

### 游戏UI组件

- **生命值显示**：显示玩家当前生命值
- **金币计数器**：显示收集的金币数量
- **击杀计数器**：显示击败的敌人数量

### 浮动文本

用于显示动态信息：

- 伤害数值
- 得分提示
- 状态变化

### 菜单系统

- **主菜单**：游戏开始界面
- **关卡选择菜单**：多关卡模式下选择关卡
- **游戏开始界面**：单关卡模式的开始界面

## 物理与碰撞系统

### 重力系统

- 使用Godot的默认重力设置
- 在跳跃和下落状态中应用重力

### 碰撞检测

- **平台碰撞**：玩家与平台的碰撞
- **敌人碰撞**：玩家与敌人的碰撞
- **金币碰撞**：玩家与金币的碰撞
- **死亡区域**：超出地图边界的死亡区域

### 射线检测

- 用于敌人的边缘检测
- 用于玩家的地面检测

---

本文档详细描述了游戏中的所有核心机制和系统。开发人员应参考此文档进行游戏功能的实现和扩展。如有任何更新或修改，请及时更新本文档。